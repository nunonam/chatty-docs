# Listing Chats


## 1. How to connect to chatlist socket.

* Should u an instance of ChattyList class to connect to chatlist socket
* When create ChattyList instance, specify 3 chatlist handlers.

Below code is a part of ChatList.tsx
```typescript
ChatList.tsx

import * as React from 'react';
import { View } from 'react-native';
import { ChattyList, ChattyTypes } from 'chatty-client';

const ChatList = (props: ChatListProps) => {
  const [chatty, setChatty] = React.useState(); // state for ChattyList instance that used in this screen
  
  ...

  /**
   * Create ChatList instance And connect
   */
  React.useEffect(() => {
    const chattylist = new ChattyList({
      onChatListConnect: onChatListConnect, // refer to below handlers section
      onChatListFetch: onChatListFetch,     // refer to below handlers section
      onChatListUpdate: onChatListUpdate    // refer to below handlers section
    });

    chattylist.connect();

    setChatty(chattylist);

    // When unmount, disconnect chatlist socket
    return () => {
      chattylist.disconnect();
    }
  }, []);

  return (
    <View>
    /* Render UI Component */
    </View>
  );
}

```

## 2. How to fetch chatlist

When chatlist is connected successfuly, call chatty.fetchChatList()

### fetchChatList payloads
- refresh: (optional) if it's true, fetch chatlist as refresh
- group: (optional) if it's specified, fetch only same as it's group name

Below code is a part of ChatList.tsx
```typescript
ChatList.tsx

...

const ChatList = (props: ChatListProps) => {
  const [chatty, setChatty] = React.useState();
  const [chatlist, setChatList] = React.useState(new Map());
  const [connected, setConnected] = React.useState(false);

  ...

  React.useEffect(() => {
    if (chatty && connected) {
      chatty.fetchChatList({ refresh: true, group: props.group });
    }
  }, [connected, chatty]);

  ...

}
```

## 3. ChatList socket handlers

### 1). onChatListConnect
This is called when chatlist socket is connected successfuly.


Below code is a part of ChatList.tsx
```typescript
ChatList.tsx

...

const ChatList = (props: ChatListProps) => {
  const [chatty, setChatty] = React.useState();
  const [chatlist, setChatList] = React.useState(new Map());
  const [connected, setConnected] = React.useState(false);

  ...

  const onChatListConnect = (data: ChattyTypes.ChatListConnectResponseType) => {
    if (data.error) {
      console.warn('onChatListConnect error', data.error.message);
      return;
    }

    setConnected(true);
  }

  ...

}
```

### 2). onChatListFetch
This is called when fetchChatList is success

Below code is a part of ChatList.tsx
```typescript
ChatList.tsx

...

const ChatList = (props: ChatListProps) => {
  const [chatty, setChatty] = React.useState();
  const [chatlist, setChatList] = React.useState(new Map());
  const [connected, setConnected] = React.useState(false);
  const [hasNext, setHasNext] = React.useState(true);

  ...

  const onChatListFetch = (data: ChattyTypes.ChatListFetchResponseType) => {
    if (data.error) {
      console.warn('onChatListFetch error', data.error.message);
      return;
    }

    /**
     * Response data type.
    data: {
      chats: [
        id: string,     // (uuid type)
        image: string,  // (url type)
        name: string,
        public: boolean,
        distinctKey: string,
        group: string,
        data: any,
        lastMessage: {
          text: string, 
          files: string[] | null, 
          type: 'TEXT' | 'FILE' | 'JSON', 
          by: 'USER' | 'ADMIN', 
          createdAt: Date,
          translation: {
            [key: string]: string
          }
        },
        updatedAt: Date,
        Members: [
          id: string,
          name: string,
          avatar: string,   // (url type)
          group: string,
          data: any,
          language: string, // (ex: "en")
          country: string,  // (ex: "US")
          missedCount: number,
          permission: "WRITE" | "READ",
          role: "MEMBER" | "ADMIN"
        ]
      ],
      hasNext: false,
      refresh: true
    }
    */

    
    if (data.refresh) {
      const messagesMap = new Map(data.chats.map((e) => [e['id'], e]));
      setChatList(messagesMap);
    } else {
      setChatList((oldChats) => {
        const chatsMap = new Map(data.chats.map((e) => [e['id'], e]));
        return new Map([...Array.from(oldChats), ...Array.from(chatsMap)]);
      });
    }

    setHasNext(data.hasNext);
  };

  ...

}
```

### 3). onChatListUpdate
This is called when need to update a specific chat of ChatList in case of navigating to Chat screen through ChatList.


### In cases of updating a specific chat of ChatList
* when lastMessage updated
* when unread messages are marked as read

Below code is a part of ChatList.tsx
```typescript
ChatList.tsx

...

const ChatList = (props: ChatListProps) => {

  ...

  const onChatListUpdate = (data: ChattyTypes.ChatListUpdateResponseType) => {
    if (data.error) {
      console.warn('onChatListRefresh error', data.error.message);
      return;
    }

    setChatList((oldChats) => {
      const chatMap = new Map([[data['id'], data]]);
      return new Map([...Array.from(oldChats), ...Array.from(chatMap)]);
    });
  };

  ...

}
```


